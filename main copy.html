<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBudget - Simulador de Presupuesto Personal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #00B894;
            --primary-dark: #00A885;
            --dark-color: #2D3436;
            --light-color: #F5F6FA;
            --white: #FFFFFF;
            --danger-color: #E17055;
            --danger-dark: #D65B3E;
            --info-color: #0984E3;
            --info-dark: #0876CC;
            --border-color: #CED6E0;
            --text-color: #333333;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --footer-bg: var(--dark-color);
            --font-size-scale: 1;
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
        }

        body.dark {
            --primary-color: #00B894;
            --primary-dark: #008f6f;
            --dark-color: #E6EEF3;
            --light-color: #071018;
            --white: #0f1720;
            --danger-color: #E17055;
            --danger-dark: #D65B3E;
            --info-color: #66a9ff;
            --info-dark: #4a8ae6;
            --border-color: rgba(255,255,255,0.06);
            --text-color: #E6EEF3;
            --shadow: 0 6px 24px rgba(0,0,0,0.6);
            --footer-bg: #081018;
            --footer-text: #E6EEF3;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--white);
            box-shadow: var(--shadow);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: var(--transition);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            height: 80px;
        }

        .sidebar-header h2 {
            font-size: calc(1.2rem * var(--font-size-scale));
            font-weight: 600;
            color: var(--dark-color);
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed .sidebar-header h2 {
            display: none;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            font-size: calc(1.2rem * var(--font-size-scale));
            cursor: pointer;
            color: var(--dark-color);
            transition: var(--transition);
        }

        .toggle-sidebar:hover {
            color: var(--primary-color);
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-color);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
            white-space: nowrap;
            overflow: hidden;
        }

        .menu-item:hover {
            background-color: var(--light-color);
            border-left-color: var(--primary-color);
        }

        .menu-item.active {
            background-color: rgba(0, 184, 148, 0.1);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }

        .menu-icon {
            font-size: calc(1.2rem * var(--font-size-scale));
            margin-right: 15px;
            min-width: 20px;
            text-align: center;
        }

        .sidebar.collapsed .menu-text {
            display: none;
        }

        .sidebar.collapsed .menu-item {
            justify-content: center;
            padding: 15px 0;
        }

        .sidebar.collapsed .menu-icon {
            margin-right: 0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: var(--sidebar-collapsed-width);
        }

        /* Header */
        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: calc(2rem * var(--font-size-scale));
            font-weight: 700;
            color: var(--dark-color);
        }

        .logo span {
            font-size: calc(1rem * var(--font-size-scale));
            color: var(--primary-color);
            font-weight: 500;
        }
        /* Bot√≥n peque√±o de tema en header */
        .header-theme-btn {
            height: 40px;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: transparent;
            cursor: pointer;
        }

        /* Bot√≥n Salir con fondo rojo */
        .header-theme-btn.logout {
            background-color: #E17055;
            color: white;
            border-color: #E17055;
            font-weight: 500;
        }

        .header-theme-btn.logout:hover {
            background-color: #D65B3E;
            border-color: #D65B3E;
        }

        /* Formularios */
        .forms-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .form-card {
            background-color: var(--white);
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .form-card h2 {
            font-size: calc(1.5rem * var(--font-size-scale));
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: calc(1rem * var(--font-size-scale));
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: calc(1rem * var(--font-size-scale));
            transition: var(--transition);
            height: 40px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: calc(1rem * var(--font-size-scale));
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            box-shadow: var(--shadow);
        }

        /* Resumen */
        .summary-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .summary-card {
            background-color: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .summary-card h3 {
            font-size: calc(1.125rem * var(--font-size-scale));
            font-weight: 500;
            margin-bottom: 10px;
        }

        .summary-amount {
            font-size: calc(1.75rem * var(--font-size-scale));
            font-weight: 700;
        }

        .income-amount {
            color: var(--primary-color);
        }

        .expense-amount {
            color: var(--danger-color);
        }

        .balance-negative {
            color: var(--danger-color);
        }

        .balance-positive {
            color: var(--primary-color);
        }

        /* Filtros */
        .filters-section {
            background-color: var(--white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filters-section h3 {
            font-size: calc(1.25rem * var(--font-size-scale));
            font-weight: 600;
            color: var(--dark-color);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tabla */
        .transactions-section {
            background-color: var(--white);
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 40px;
            overflow-x: auto;
        }

        .transactions-section h2 {
            font-size: calc(1.5rem * var(--font-size-scale));
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: calc(0.95rem * var(--font-size-scale));
        }

        th {
            font-weight: 600;
            color: var(--dark-color);
        }

        .transaction-income {
            color: var(--primary-color);
        }

        .transaction-expense {
            color: var(--danger-color);
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            transition: var(--transition);
            border-radius: 5px;
        }

        .btn-edit {
            color: var(--info-color);
        }

        .btn-edit:hover {
            background-color: rgba(9, 132, 227, 0.1);
        }

        .btn-delete {
            color: var(--danger-color);
        }

        .btn-delete:hover {
            background-color: rgba(225, 112, 85, 0.1);
        }

        /* Gr√°ficas */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background-color: var(--white);
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .chart-card h2 {
            font-size: calc(1.5rem * var(--font-size-scale));
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Estad√≠sticas Avanzadas */
        .stats-section {
            margin-bottom: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-card {
            background-color: var(--white);
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .stats-card h3 {
            font-size: calc(1.25rem * var(--font-size-scale));
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: var(--text-color);
        }

        .stat-value {
            font-weight: 600;
            color: var(--dark-color);
        }

        .stat-positive {
            color: var(--primary-color);
        }

        .stat-negative {
            color: var(--danger-color);
        }

        .stat-neutral {
            color: var(--info-color);
        }

        .stats-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        /* Footer */
        footer {
            background-color: var(--footer-bg);
            color: #FFFFFF;
            padding: 30px 0;
            text-align: center;
            margin-top: auto;
        }

        footer p {
            font-size: calc(0.875rem * var(--font-size-scale));
            color: #FFFFFF;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: calc(1.5rem * var(--font-size-scale));
            font-weight: 600;
            color: var(--dark-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: calc(1.5rem * var(--font-size-scale));
            cursor: pointer;
            color: var(--dark-color);
        }

        /* Settings Menu */
        .settings-menu {
            position: relative;
        }

        .settings-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px 10px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background-color: var(--light-color);
        }

        .settings-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 280px;
            padding: 20px;
            z-index: 2000;
            display: none;
        }

        .settings-dropdown.show {
            display: block;
        }

        .settings-dropdown h3 {
            font-size: calc(1.125rem * var(--font-size-scale));
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark-color);
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section label {
            font-size: calc(0.875rem * var(--font-size-scale));
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: var(--border-color);
            border-radius: 13px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-switch.active {
            background-color: var(--primary-color);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background-color: var(--white);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: var(--transition);
        }

        .toggle-switch.active::after {
            left: 26px;
        }

        .size-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .size-btn {
            background-color: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: calc(0.85rem * var(--font-size-scale));
            font-weight: 500;
            transition: var(--transition);
            min-width: 35px;
        }

        .size-btn:hover {
            background-color: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .size-btn.active {
            background-color: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .size-display {
            font-size: calc(0.75rem * var(--font-size-scale));
            color: var(--text-color);
            text-align: center;
            margin-top: 8px;
            font-weight: 500;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--primary-color);
            color: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 1001;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background-color: var(--danger-color);
        }

        /* Responsive */
        @media (max-width: 992px) {
            .forms-section, .charts-section, .stats-charts {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .summary-section {
                grid-template-columns: 1fr;
            }
            
            .filters-section {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .sidebar {
                width: var(--sidebar-collapsed-width);
            }

            .sidebar.collapsed {
                width: 0;
            }

            .main-content {
                margin-left: var(--sidebar-collapsed-width);
            }

            .sidebar.collapsed ~ .main-content {
                margin-left: 0;
            }

            .sidebar-header h2, .menu-text {
                display: none;
            }

            .sidebar .menu-item {
                justify-content: center;
                padding: 15px 0;
            }

            .sidebar .menu-icon {
                margin-right: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>SmartBudget</h2>
            <button class="toggle-sidebar" id="toggle-sidebar">‚ò∞</button>
        </div>
        <nav class="sidebar-menu">
            <a href="#forms" class="menu-item active" data-section="forms">
                <span class="menu-icon">üìù</span>
                <span class="menu-text">Agregar Transacciones</span>
            </a>
            <a href="#summary" class="menu-item" data-section="summary">
                <span class="menu-icon">üìä</span>
                <span class="menu-text">Resumen Financiero</span>
            </a>
            <a href="#filters" class="menu-item" data-section="filters">
                <span class="menu-icon">üîç</span>
                <span class="menu-text">Filtrar Transacciones</span>
            </a>
            <a href="#transactions" class="menu-item" data-section="transactions">
                <span class="menu-icon">üìã</span>
                <span class="menu-text">Historial</span>
            </a>
            <a href="#charts" class="menu-item" data-section="charts">
                <span class="menu-icon">üìà</span>
                <span class="menu-text">Gr√°ficas</span>
            </a>
            <a href="#stats" class="menu-item" data-section="stats">
                <span class="menu-icon">üßÆ</span>
                <span class="menu-text">Estad√≠sticas Avanzadas</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <h1>üí∞ SmartBudget</h1>
                        <span>Administra tus finanzas f√°cilmente</span>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <div class="settings-menu">
                            <button class="settings-btn" id="settings-toggle" aria-label="Configuraciones">‚öôÔ∏è</button>
                            <div class="settings-dropdown" id="settings-dropdown">
                                <h3>‚öôÔ∏è Configuraciones</h3>
                                
                                <div class="settings-section">
                                    <label>Tema</label>
                                    <div class="settings-toggle">
                                        <span style="font-size: 18px;">üåô</span>
                                        <div class="toggle-switch" id="theme-toggle-switch"></div>
                                        <span style="font-size: 18px;">‚òÄÔ∏è</span>
                                    </div>
                                </div>

                                <div class="settings-section">
                                    <label>Tama√±o de Letras</label>
                                    <div class="size-controls">
                                        <button class="size-btn" id="size-small" title="Peque√±o">A-</button>
                                        <button class="size-btn active" id="size-medium" title="Mediano">A</button>
                                        <button class="size-btn" id="size-large" title="Grande">A+</button>
                                    </div>
                                    <div class="size-display" id="size-display">100%</div>
                                </div>
                            </div>
                        </div>
                        <button id="logout-btn" class="header-theme-btn logout" aria-label="Salir">Salir</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Secci√≥n de formularios -->
            <section class="forms-section" id="forms-section">
                <!-- Formulario de ingresos -->
                <div class="form-card">
                    <h2>üí≤ Agregar Ingreso</h2>
                    <form id="income-form">
                        <div class="form-group">
                            <label for="income-amount">Monto</label>
                            <input type="number" id="income-amount" placeholder="0.00" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="income-category">Categor√≠a</label>
                            <select id="income-category" required>
                                <option value="">Selecciona una categor√≠a</option>
                                <option value="Salario">Salario</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Inversiones">Inversiones</option>
                                <option value="Regalos">Regalos</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="income-description">Descripci√≥n</label>
                            <input type="text" id="income-description" placeholder="Descripci√≥n del ingreso">
                        </div>
                        <div class="form-group">
                            <label for="income-date">Fecha</label>
                            <input type="date" id="income-date" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar Ingreso</button>
                    </form>
                </div>

                <!-- Formulario de gastos -->
                <div class="form-card">
                    <h2>üí∏ Agregar Gasto</h2>
                    <form id="expense-form">
                        <div class="form-group">
                            <label for="expense-amount">Monto</label>
                            <input type="number" id="expense-amount" placeholder="0.00" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="expense-category">Categor√≠a</label>
                            <select id="expense-category" required>
                                <option value="">Selecciona una categor√≠a</option>
                                <option value="Alimentaci√≥n">Alimentaci√≥n</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Vivienda">Vivienda</option>
                                <option value="Entretenimiento">Entretenimiento</option>
                                <option value="Salud">Salud</option>
                                <option value="Educaci√≥n">Educaci√≥n</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expense-description">Descripci√≥n</label>
                            <input type="text" id="expense-description" placeholder="Descripci√≥n del gasto">
                        </div>
                        <div class="form-group">
                            <label for="expense-date">Fecha</label>
                            <input type="date" id="expense-date" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar Gasto</button>
                    </form>
                </div>
            </section>

            <!-- Secci√≥n de resumen -->
            <section class="summary-section" id="summary-section">
                <div class="summary-card">
                    <h3>Total Ingresos</h3>
                    <div class="summary-amount income-amount" id="total-income">$0.00</div>
                </div>
                <div class="summary-card">
                    <h3>Total Gastos</h3>
                    <div class="summary-amount expense-amount" id="total-expenses">$0.00</div>
                </div>
                <div class="summary-card">
                    <h3>Balance General</h3>
                    <div class="summary-amount" id="balance">$0.00</div>
                </div>
            </section>

            <!-- Filtros -->
            <section class="filters-section" id="filters-section">
                <h3>Filtrar por:</h3>
                <div class="filter-group">
                    <label for="filter-type">Tipo:</label>
                    <select id="filter-type">
                        <option value="all">Todos</option>
                        <option value="income">Ingresos</option>
                        <option value="expense">Gastos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-category">Categor√≠a:</label>
                    <select id="filter-category">
                        <option value="all">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-date">Mes:</label>
                    <input type="month" id="filter-date">
                </div>
            </section>

            <!-- Tabla de transacciones -->
            <section class="transactions-section" id="transactions-section">
                <h2>Historial de Transacciones</h2>
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Categor√≠a</th>
                            <th>Descripci√≥n</th>
                            <th>Fecha</th>
                            <th>Monto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- Las transacciones se cargar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
            </section>

            <!-- Gr√°ficas -->
            <section class="charts-section" id="charts-section">
                <div class="chart-card">
                    <h2>Distribuci√≥n de Gastos</h2>
                    <div class="chart-container">
                        <canvas id="expenses-chart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h2>Evoluci√≥n Mensual</h2>
                    <div class="chart-container">
                        <canvas id="monthly-chart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Estad√≠sticas Avanzadas -->
            <section class="stats-section" id="stats-section">
                <h2 style="font-size: calc(1.5rem * var(--font-size-scale)); font-weight: 600; margin-bottom: 20px; color: var(--dark-color); display: flex; align-items: center; gap: 10px;">
                    üßÆ Estad√≠sticas Avanzadas
                </h2>
                
                <div class="stats-grid">
                    <!-- M√©tricas de Tendencia Central -->
                    <div class="stats-card">
                        <h3>üìà Tendencia Central</h3>
                        <div class="stat-item">
                            <span class="stat-label">Media de Ingresos:</span>
                            <span class="stat-value stat-positive" id="mean-income">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Media de Gastos:</span>
                            <span class="stat-value stat-negative" id="mean-expense">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Mediana Ingresos:</span>
                            <span class="stat-value stat-positive" id="median-income">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Mediana Gastos:</span>
                            <span class="stat-value stat-negative" id="median-expense">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Moda Ingresos:</span>
                            <span class="stat-value stat-positive" id="mode-income">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Moda Gastos:</span>
                            <span class="stat-value stat-negative" id="mode-expense">$0.00</span>
                        </div>
                    </div>

                    <!-- M√©tricas de Dispersi√≥n -->
                    <div class="stats-card">
                        <h3>üìä Dispersi√≥n y Variabilidad</h3>
                        <div class="stat-item">
                            <span class="stat-label">Desv. Est√°ndar Ingresos:</span>
                            <span class="stat-value stat-neutral" id="std-income">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Desv. Est√°ndar Gastos:</span>
                            <span class="stat-value stat-neutral" id="std-expense">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Rango Intercuart√≠lico Ingresos:</span>
                            <span class="stat-value stat-neutral" id="iqr-income">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Rango Intercuart√≠lico Gastos:</span>
                            <span class="stat-value stat-neutral" id="iqr-expense">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Coef. Variaci√≥n Ingresos:</span>
                            <span class="stat-value stat-neutral" id="cv-income">0%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Coef. Variaci√≥n Gastos:</span>
                            <span class="stat-value stat-neutral" id="cv-expense">0%</span>
                        </div>
                    </div>

                    <!-- Ratios Financieros -->
                    <div class="stats-card">
                        <h3>üéØ Ratios Financieros</h3>
                        <div class="stat-item">
                            <span class="stat-label">Ratio de Ahorro:</span>
                            <span class="stat-value stat-positive" id="savings-ratio">0%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Gastos Fijos:</span>
                            <span class="stat-value stat-neutral" id="fixed-expenses-ratio">0%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Gastos Variables:</span>
                            <span class="stat-value stat-neutral" id="variable-expenses-ratio">0%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Ratio Endeudamiento:</span>
                            <span class="stat-value stat-negative" id="debt-ratio">0%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Tendencia Mensual:</span>
                            <span class="stat-value stat-positive" id="monthly-trend">0%</span>
                        </div>
                    </div>

                    <!-- An√°lisis Predictivo -->
                    <div class="stats-card">
                        <h3>üîÆ An√°lisis Predictivo</h3>
                        <div class="stat-item">
                            <span class="stat-label">Proyecci√≥n 3 Meses:</span>
                            <span class="stat-value stat-positive" id="projection-3m">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Proyecci√≥n 6 Meses:</span>
                            <span class="stat-value stat-positive" id="projection-6m">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Proyecci√≥n 12 Meses:</span>
                            <span class="stat-value stat-positive" id="projection-12m">$0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Anomal√≠as Detectadas:</span>
                            <span class="stat-value stat-negative" id="anomalies-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Media M√≥vil (3 meses):</span>
                            <span class="stat-value stat-neutral" id="moving-average">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficas Adicionales -->
                <div class="stats-charts">
                    <div class="chart-card">
                        <h2>üìÖ Patr√≥n Semanal de Gastos</h2>
                        <div class="chart-container">
                            <canvas id="weekly-pattern-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h2>üìà Tendencias y Proyecciones</h2>
                        <div class="chart-container">
                            <canvas id="trend-projection-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <footer class="site-footer">
            <div class="container">
                <p>¬© 2025 SmartBudget - Simulador de Presupuesto Personal</p>
            </div>
        </footer>
    </div>

    <!-- Modal para editar transacciones -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Editar Transacci√≥n</h2>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-type">
                
                <div class="form-group">
                    <label for="edit-amount">Monto</label>
                    <input type="number" id="edit-amount" placeholder="0.00" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="edit-category">Categor√≠a</label>
                    <select id="edit-category" required>
                        <!-- Las opciones se cargar√°n din√°micamente seg√∫n el tipo -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-description">Descripci√≥n</label>
                    <input type="text" id="edit-description" placeholder="Descripci√≥n">
                </div>
                <div class="form-group">
                    <label for="edit-date">Fecha</label>
                    <input type="date" id="edit-date" required>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- Toast para notificaciones -->
    <div class="toast" id="toast"></div>

    <script>
        // Clase para manejar las transacciones
        class TransactionManager {
            constructor() {
                this.transactions = this.loadTransactions();
                this.nextId = this.getNextId();
                this.init();
            }

            // Inicializar la aplicaci√≥n
            init() {
                this.setupEventListeners();
                this.updateUI();
                this.setDefaultDates();
                // Escuchar cambios de tema para actualizar colores de las gr√°ficas
                window.addEventListener('themeChange', () => {
                    this.updateCharts();
                });
            }

            // Configurar event listeners
            setupEventListeners() {
                // Formularios
                document.getElementById('income-form').addEventListener('submit', (e) => this.handleFormSubmit(e, 'income'));
                document.getElementById('expense-form').addEventListener('submit', (e) => this.handleFormSubmit(e, 'expense'));
                
                // Filtros
                document.getElementById('filter-type').addEventListener('change', () => this.updateUI());
                document.getElementById('filter-category').addEventListener('change', () => this.updateUI());
                document.getElementById('filter-date').addEventListener('change', () => this.updateUI());
                
                // Modal
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('edit-form').addEventListener('submit', (e) => this.handleEditSubmit(e));
                
                // Cerrar modal al hacer clic fuera
                document.getElementById('edit-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'edit-modal') this.closeModal();
                });
            }

            // Establecer fechas por defecto
            setDefaultDates() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('income-date').value = today;
                document.getElementById('expense-date').value = today;
                
                const currentMonth = new Date().toISOString().substring(0, 7);
                document.getElementById('filter-date').value = currentMonth;
            }

            // Manejar env√≠o de formularios
            handleFormSubmit(e, type) {
                e.preventDefault();
                
                const amount = parseFloat(document.getElementById(`${type}-amount`).value);
                const category = document.getElementById(`${type}-category`).value;
                const description = document.getElementById(`${type}-description`).value;
                const date = document.getElementById(`${type}-date`).value;
                
                if (!amount || !category || !date) {
                    this.showToast('Por favor, completa todos los campos obligatorios', 'error');
                    return;
                }
                
                const transaction = {
                    id: this.nextId++,
                    type,
                    amount,
                    category,
                    description,
                    date
                };
                
                this.addTransaction(transaction);
                this.resetForm(`${type}-form`);
                this.showToast(`${type === 'income' ? 'Ingreso' : 'Gasto'} agregado correctamente`);
            }

            // Manejar env√≠o del formulario de edici√≥n
            handleEditSubmit(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('edit-id').value);
                const type = document.getElementById('edit-type').value;
                const amount = parseFloat(document.getElementById('edit-amount').value);
                const category = document.getElementById('edit-category').value;
                const description = document.getElementById('edit-description').value;
                const date = document.getElementById('edit-date').value;
                
                if (!amount || !category || !date) {
                    this.showToast('Por favor, completa todos los campos obligatorios', 'error');
                    return;
                }
                
                const transaction = {
                    id,
                    type,
                    amount,
                    category,
                    description,
                    date
                };
                
                this.updateTransaction(transaction);
                this.closeModal();
                this.showToast('Transacci√≥n actualizada correctamente');
            }

            // Agregar transacci√≥n
            addTransaction(transaction) {
                this.transactions.push(transaction);
                this.saveTransactions();
                this.updateUI();
            }

            // Actualizar transacci√≥n
            updateTransaction(updatedTransaction) {
                const index = this.transactions.findIndex(t => t.id === updatedTransaction.id);
                if (index !== -1) {
                    this.transactions[index] = updatedTransaction;
                    this.saveTransactions();
                    this.updateUI();
                }
            }

            // Eliminar transacci√≥n
            deleteTransaction(id) {
                if (confirm('¬øEst√°s seguro de que quieres eliminar esta transacci√≥n?')) {
                    this.transactions = this.transactions.filter(t => t.id !== id);
                    this.saveTransactions();
                    this.updateUI();
                    this.showToast('Transacci√≥n eliminada correctamente');
                }
            }

            // Abrir modal para editar
            openEditModal(id) {
                const transaction = this.transactions.find(t => t.id === id);
                if (!transaction) return;
                
                document.getElementById('edit-id').value = transaction.id;
                document.getElementById('edit-type').value = transaction.type;
                document.getElementById('edit-amount').value = transaction.amount;
                document.getElementById('edit-description').value = transaction.description;
                document.getElementById('edit-date').value = transaction.date;
                
                // Cargar categor√≠as seg√∫n el tipo
                const categorySelect = document.getElementById('edit-category');
                categorySelect.innerHTML = '';
                
                const categories = transaction.type === 'income' 
                    ? ['Salario', 'Freelance', 'Inversiones', 'Regalos', 'Otros']
                    : ['Alimentaci√≥n', 'Transporte', 'Vivienda', 'Entretenimiento', 'Salud', 'Educaci√≥n', 'Otros'];
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    if (cat === transaction.category) option.selected = true;
                    categorySelect.appendChild(option);
                });
                
                document.getElementById('modal-title').textContent = `Editar ${transaction.type === 'income' ? 'Ingreso' : 'Gasto'}`;
                document.getElementById('edit-modal').style.display = 'flex';
            }

            // Cerrar modal
            closeModal() {
                document.getElementById('edit-modal').style.display = 'none';
            }

            // Obtener transacciones filtradas
            getFilteredTransactions() {
                const typeFilter = document.getElementById('filter-type').value;
                const categoryFilter = document.getElementById('filter-category').value;
                const dateFilter = document.getElementById('filter-date').value;
                
                return this.transactions.filter(transaction => {
                    // Filtrar por tipo
                    if (typeFilter !== 'all' && transaction.type !== typeFilter) return false;
                    
                    // Filtrar por categor√≠a
                    if (categoryFilter !== 'all' && transaction.category !== categoryFilter) return false;
                    
                    // Filtrar por fecha
                    if (dateFilter && !transaction.date.startsWith(dateFilter)) return false;
                    
                    return true;
                });
            }

            // Actualizar la interfaz de usuario
            updateUI() {
                this.updateSummary();
                this.updateTransactionsTable();
                this.updateCharts();
                this.updateCategoryFilter();
                this.updateAdvancedStats();
            }

            // Actualizar resumen
            updateSummary() {
                const totalIncome = this.transactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalExpenses = this.transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const balance = totalIncome - totalExpenses;
                
                document.getElementById('total-income').textContent = `$${totalIncome.toFixed(2)}`;
                document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
                
                const balanceElement = document.getElementById('balance');
                balanceElement.textContent = `$${balance.toFixed(2)}`;
                balanceElement.className = `summary-amount ${balance >= 0 ? 'balance-positive' : 'balance-negative'}`;
            }

            // Actualizar tabla de transacciones
            updateTransactionsTable() {
                const transactionsBody = document.getElementById('transactions-body');
                const filteredTransactions = this.getFilteredTransactions();
                
                transactionsBody.innerHTML = '';
                
                if (filteredTransactions.length === 0) {
                    transactionsBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 20px;">
                                No hay transacciones que coincidan con los filtros seleccionados
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                filteredTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${transaction.type === 'income' ? 'üí≤ Ingreso' : 'üí∏ Gasto'}</td>
                        <td>${transaction.category}</td>
                        <td>${transaction.description || '-'}</td>
                        <td>${this.formatDate(transaction.date)}</td>
                        <td class="${transaction.type === 'income' ? 'transaction-income' : 'transaction-expense'}">
                            $${transaction.amount.toFixed(2)}
                        </td>
                        <td>
                            <button class="btn-icon btn-edit" data-id="${transaction.id}">‚öôÔ∏è</button>
                            <button class="btn-icon btn-delete" data-id="${transaction.id}">üóëÔ∏è</button>
                        </td>
                    `;
                    
                    transactionsBody.appendChild(row);
                });
                
                // Agregar event listeners a los botones
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', () => this.openEditModal(parseInt(btn.dataset.id)));
                });
                
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', () => this.deleteTransaction(parseInt(btn.dataset.id)));
                });
            }

            // Actualizar gr√°ficas
            updateCharts() {
                this.updateExpensesChart();
                this.updateMonthlyChart();
                this.updateWeeklyPatternChart();
                this.updateTrendProjectionChart();
            }

            // Actualizar gr√°fica de gastos
            updateExpensesChart() {
                const ctx = document.getElementById('expenses-chart').getContext('2d');
                
                // Obtener gastos por categor√≠a
                const expensesByCategory = {};
                this.transactions
                    .filter(t => t.type === 'expense')
                    .forEach(t => {
                        expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                    });
                
                const categories = Object.keys(expensesByCategory);
                const amounts = Object.values(expensesByCategory);
                
                // Colores para las categor√≠as (elige paleta seg√∫n tema)
                const isDark = document.body.classList.contains('dark');
                const backgroundColors = isDark
                    ? ['#FF8FA3', '#7BE3BF', '#7FB7FF', '#A08CFF', '#FFE59D', '#FFB39A', '#BFC6CC', '#FF9AD6']
                    : ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#7CFFB2'];
                
                // Destruir gr√°fica anterior si existe
                if (this.expensesChart) {
                    this.expensesChart.destroy();
                }

                // Colores base
                const bgColors = backgroundColors.slice(0, categories.length);

                // Determinar colores de texto seg√∫n tema
                const styles = getComputedStyle(document.body);
                const textColor = styles.getPropertyValue('--text-color').trim() || (isDark ? '#E6EEF3' : '#333');
                const tooltipBg = isDark ? '#0b1115' : '#fff';
                const tooltipTitleColor = isDark ? '#E6EEF3' : '#111';

                // Crear nueva gr√°fica con adaptaci√≥n de colores y tooltips
                this.expensesChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: amounts,
                            backgroundColor: bgColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: textColor }
                            },
                            tooltip: {
                                backgroundColor: tooltipBg,
                                titleColor: tooltipTitleColor,
                                bodyColor: textColor
                            }
                        }
                    }
                });
            }

            // Actualizar gr√°fica mensual
            updateMonthlyChart() {
                const canvasElement = document.getElementById('monthly-chart');
                if (!canvasElement) {
                    console.error('Canvas "monthly-chart" no encontrado');
                    return;
                }

                const ctx = canvasElement.getContext('2d');
                
                // Obtener ingresos y gastos por mes
                const monthlyData = {};
                
                this.transactions.forEach(t => {
                    const month = t.date.substring(0, 7); // Formato YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = { income: 0, expenses: 0 };
                    }
                    
                    if (t.type === 'income') {
                        monthlyData[month].income += t.amount;
                    } else {
                        monthlyData[month].expenses += t.amount;
                    }
                });
                
                const months = Object.keys(monthlyData).sort();
                const incomeData = months.map(month => monthlyData[month].income);
                const expensesData = months.map(month => monthlyData[month].expenses);
                
                // Destruir gr√°fica anterior si existe
                if (this.monthlyChart) {
                    this.monthlyChart.destroy();
                }

                // Si no hay datos, mostrar mensaje y no crear gr√°fica
                if (months.length === 0) {
                    console.warn('No hay datos de transacciones para mostrar en la gr√°fica mensual');
                    ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-color').trim() || '#333';
                    ctx.font = '16px Poppins';
                    ctx.textAlign = 'center';
                    ctx.fillText('Agrega transacciones para ver la evoluci√≥n mensual', canvasElement.width / 2, canvasElement.height / 2);
                    return;
                }

                // Determinar colores seg√∫n el tema actual (CSS variables)
                const styles2 = getComputedStyle(document.body);
                const textColor2 = styles2.getPropertyValue('--text-color').trim() || (document.body.classList.contains('dark') ? '#E6EEF3' : '#333');
                const gridColor = styles2.getPropertyValue('--border-color').trim() || (document.body.classList.contains('dark') ? 'rgba(255,255,255,0.06)' : '#CED6E0');

                // Crear nueva gr√°fica con colores que funcionen en modo oscuro
                this.monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months.map(month => this.formatMonth(month)),
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: incomeData,
                                backgroundColor: document.body.classList.contains('dark') ? 'rgba(0, 184, 148, 0.9)' : 'rgba(0, 184, 148, 0.7)',
                                borderColor: 'rgba(0, 184, 148, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Gastos',
                                data: expensesData,
                                backgroundColor: document.body.classList.contains('dark') ? 'rgba(225, 112, 85, 0.9)' : 'rgba(225, 112, 85, 0.7)',
                                borderColor: 'rgba(225, 112, 85, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: { color: textColor2 },
                                grid: { color: 'transparent' }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: textColor2 },
                                grid: { color: gridColor }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: textColor2 } }
                        }
                    }
                });
            }

            // Actualizar gr√°fica de patr√≥n semanal
            updateWeeklyPatternChart() {
                const ctx = document.getElementById('weekly-pattern-chart').getContext('2d');
                
                // Obtener gastos por d√≠a de la semana
                const dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                const gastosPorDia = {};
                dias.forEach(dia => gastosPorDia[dia] = 0);
                
                this.transactions
                    .filter(t => t.type === 'expense')
                    .forEach(t => {
                        const fecha = new Date(t.date);
                        const diaSemana = dias[fecha.getDay()];
                        gastosPorDia[diaSemana] += t.amount;
                    });
                
                const datos = dias.map(dia => gastosPorDia[dia]);
                
                // Destruir gr√°fica anterior si existe
                if (this.weeklyPatternChart) {
                    this.weeklyPatternChart.destroy();
                }

                // Determinar colores seg√∫n el tema actual
                const isDark = document.body.classList.contains('dark');
                const styles = getComputedStyle(document.body);
                const textColor = styles.getPropertyValue('--text-color').trim() || (isDark ? '#E6EEF3' : '#333');
                const gridColor = styles.getPropertyValue('--border-color').trim() || (isDark ? 'rgba(255,255,255,0.06)' : '#CED6E0');
                const primaryColor = styles.getPropertyValue('--primary-color').trim() || '#00B894';

                // Crear nueva gr√°fica
                this.weeklyPatternChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dias,
                        datasets: [{
                            label: 'Gastos por D√≠a',
                            data: datos,
                            backgroundColor: isDark ? 'rgba(225, 112, 85, 0.7)' : 'rgba(225, 112, 85, 0.7)',
                            borderColor: 'rgba(225, 112, 85, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { color: 'transparent' }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: textColor } }
                        }
                    }
                });
            }

            // Actualizar gr√°fica de tendencias y proyecciones
            updateTrendProjectionChart() {
                const ctx = document.getElementById('trend-projection-chart').getContext('2d');
                
                // Obtener datos hist√≥ricos y proyecciones
                const historialMensual = this.agruparPorMes(this.transactions);
                const proyecciones = this.proyectarAhorros(this.transactions, 6);
                
                const mesesHistorial = historialMensual.map(item => this.formatMonth(item.mes));
                const balancesHistorial = historialMensual.map(item => this.calcularBalanceMensual(item));
                
                const mesesProyeccion = proyecciones.map((_, i) => `Proy ${i+1}`);
                const balancesProyeccion = proyecciones.map(p => p.proyeccion);
                
                // Destruir gr√°fica anterior si existe
                if (this.trendProjectionChart) {
                    this.trendProjectionChart.destroy();
                }

                // Determinar colores seg√∫n el tema actual
                const isDark = document.body.classList.contains('dark');
                const styles = getComputedStyle(document.body);
                const textColor = styles.getPropertyValue('--text-color').trim() || (isDark ? '#E6EEF3' : '#333');
                const gridColor = styles.getPropertyValue('--border-color').trim() || (isDark ? 'rgba(255,255,255,0.06)' : '#CED6E0');

                // Crear nueva gr√°fica
                this.trendProjectionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [...mesesHistorial, ...mesesProyeccion],
                        datasets: [
                            {
                                label: 'Balance Hist√≥rico',
                                data: [...balancesHistorial, ...Array(mesesProyeccion.length).fill(null)],
                                borderColor: isDark ? 'rgba(0, 184, 148, 1)' : 'rgba(0, 184, 148, 1)',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                tension: 0.1
                            },
                            {
                                label: 'Proyecci√≥n',
                                data: [...Array(mesesHistorial.length).fill(null), ...balancesProyeccion],
                                borderColor: isDark ? 'rgba(255, 193, 7, 1)' : 'rgba(255, 193, 7, 1)',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { color: 'transparent' }
                            },
                            y: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: textColor } }
                        }
                    }
                });
            }

            // Actualizar filtro de categor√≠as
            updateCategoryFilter() {
                const categoryFilter = document.getElementById('filter-category');
                const currentValue = categoryFilter.value;
                
                // Obtener todas las categor√≠as √∫nicas
                const categories = [...new Set(this.transactions.map(t => t.category))].sort();
                
                // Actualizar opciones
                categoryFilter.innerHTML = '<option value="all">Todas</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    if (cat === currentValue) option.selected = true;
                    categoryFilter.appendChild(option);
                });
            }

            // Actualizar estad√≠sticas avanzadas
            updateAdvancedStats() {
                // M√©tricas de Tendencia Central
                const meanIncome = this.calcularMedia(this.transactions, 'income');
                const meanExpense = this.calcularMedia(this.transactions, 'expense');
                const medianIncome = this.calcularMediana(this.transactions, 'income');
                const medianExpense = this.calcularMediana(this.transactions, 'expense');
                const modeIncome = this.calcularModa(this.transactions, 'income');
                const modeExpense = this.calcularModa(this.transactions, 'expense');
                
                document.getElementById('mean-income').textContent = `$${meanIncome.toFixed(2)}`;
                document.getElementById('mean-expense').textContent = `$${meanExpense.toFixed(2)}`;
                document.getElementById('median-income').textContent = `$${medianIncome.toFixed(2)}`;
                document.getElementById('median-expense').textContent = `$${medianExpense.toFixed(2)}`;
                document.getElementById('mode-income').textContent = `$${modeIncome.toFixed(2)}`;
                document.getElementById('mode-expense').textContent = `$${modeExpense.toFixed(2)}`;
                
                // M√©tricas de Dispersi√≥n
                const stdIncome = this.calcularDesviacionEstandar(this.transactions, 'income');
                const stdExpense = this.calcularDesviacionEstandar(this.transactions, 'expense');
                const iqrIncome = this.calcularIQR(this.transactions, 'income');
                const iqrExpense = this.calcularIQR(this.transactions, 'expense');
                const cvIncome = this.calcularCoeficienteVariacion(this.transactions, 'income');
                const cvExpense = this.calcularCoeficienteVariacion(this.transactions, 'expense');
                
                document.getElementById('std-income').textContent = `$${stdIncome.toFixed(2)}`;
                document.getElementById('std-expense').textContent = `$${stdExpense.toFixed(2)}`;
                document.getElementById('iqr-income').textContent = `$${iqrIncome.toFixed(2)}`;
                document.getElementById('iqr-expense').textContent = `$${iqrExpense.toFixed(2)}`;
                document.getElementById('cv-income').textContent = `${cvIncome.toFixed(2)}%`;
                document.getElementById('cv-expense').textContent = `${cvExpense.toFixed(2)}%`;
                
                // Ratios Financieros
                const savingsRatio = this.calcularRatioAhorro(this.transactions);
                const expenseRatios = this.calcularRatioGastos(this.transactions);
                const debtRatio = this.calcularRatioEndeudamiento(this.transactions);
                const monthlyTrend = this.calcularCrecimientoMensual(this.transactions, 'income');
                
                document.getElementById('savings-ratio').textContent = `${savingsRatio.ratio.toFixed(2)}%`;
                document.getElementById('fixed-expenses-ratio').textContent = `${expenseRatios.fijos.toFixed(2)}%`;
                document.getElementById('variable-expenses-ratio').textContent = `${expenseRatios.variables.toFixed(2)}%`;
                document.getElementById('debt-ratio').textContent = `${debtRatio.toFixed(2)}%`;
                document.getElementById('monthly-trend').textContent = `${monthlyTrend.length > 0 ? monthlyTrend[monthlyTrend.length - 1].crecimiento.toFixed(2) : 0}%`;
                
                // An√°lisis Predictivo
                const projection3m = this.proyectarAhorros(this.transactions, 3);
                const projection6m = this.proyectarAhorros(this.transactions, 6);
                const projection12m = this.proyectarAhorros(this.transactions, 12);
                const anomalies = this.detectarAnomalias(this.transactions, 'expense');
                const movingAverage = this.calcularMediaMovil(this.transactions, 'income', 3);
                
                document.getElementById('projection-3m').textContent = `$${projection3m.length > 0 ? projection3m[projection3m.length - 1].proyeccion.toFixed(2) : 0}`;
                document.getElementById('projection-6m').textContent = `$${projection6m.length > 0 ? projection6m[projection6m.length - 1].proyeccion.toFixed(2) : 0}`;
                document.getElementById('projection-12m').textContent = `$${projection12m.length > 0 ? projection12m[projection12m.length - 1].proyeccion.toFixed(2) : 0}`;
                document.getElementById('anomalies-count').textContent = anomalies.length;
                document.getElementById('moving-average').textContent = `$${movingAverage.length > 0 ? movingAverage[movingAverage.length - 1].mediaMovil.toFixed(2) : 0}`;
            }

            // M√©tricas de Tendencia Central
            calcularMedia(transacciones, tipo) {
                const filtradas = transacciones.filter(t => t.type === tipo);
                if (filtradas.length === 0) return 0;
                return filtradas.reduce((sum, t) => sum + t.amount, 0) / filtradas.length;
            }

            calcularMediana(transacciones, tipo) {
                const montos = transacciones
                    .filter(t => t.type === tipo)
                    .map(t => t.amount)
                    .sort((a, b) => a - b);
                
                if (montos.length === 0) return 0;
                
                const medio = Math.floor(montos.length / 2);
                return montos.length % 2 === 0 
                    ? (montos[medio - 1] + montos[medio]) / 2 
                    : montos[medio];
            }

            calcularModa(transacciones, tipo) {
                const frecuencia = {};
                transacciones
                    .filter(t => t.type === tipo)
                    .forEach(t => {
                        frecuencia[t.amount] = (frecuencia[t.amount] || 0) + 1;
                    });
                
                if (Object.keys(frecuencia).length === 0) return 0;
                
                return Object.keys(frecuencia).reduce((a, b) => 
                    frecuencia[a] > frecuencia[b] ? parseFloat(a) : parseFloat(b)
                );
            }

            // M√©tricas de Dispersi√≥n
            calcularDesviacionEstandar(transacciones, tipo) {
                const montos = transacciones.filter(t => t.type === tipo).map(t => t.amount);
                if (montos.length === 0) return 0;
                
                const media = this.calcularMedia(transacciones, tipo);
                const varianza = montos.reduce((sum, monto) => 
                    sum + Math.pow(monto - media, 2), 0) / montos.length;
                
                return Math.sqrt(varianza);
            }

            calcularIQR(transacciones, tipo) {
                const montos = transacciones
                    .filter(t => t.type === tipo)
                    .map(t => t.amount)
                    .sort((a, b) => a - b);
                
                if (montos.length === 0) return 0;
                
                const Q1 = montos[Math.floor(montos.length * 0.25)];
                const Q3 = montos[Math.floor(montos.length * 0.75)];
                
                return Q3 - Q1;
            }

            calcularCoeficienteVariacion(transacciones, tipo) {
                const media = this.calcularMedia(transacciones, tipo);
                if (media === 0) return 0;
                
                const desviacion = this.calcularDesviacionEstandar(transacciones, tipo);
                return (desviacion / media) * 100;
            }

            // Ratios Financieros
            calcularRatioGastos(transacciones) {
                const gastosFijos = ['Vivienda', 'Transporte', 'Salud'];
                const gastosVariables = ['Entretenimiento', 'Alimentaci√≥n', 'Otros'];
                
                const totalFijos = transacciones
                    .filter(t => t.type === 'expense' && gastosFijos.includes(t.category))
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalVariables = transacciones
                    .filter(t => t.type === 'expense' && gastosVariables.includes(t.category))
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalGastos = totalFijos + totalVariables;
                
                if (totalGastos === 0) return { fijos: 0, variables: 0 };
                
                return {
                    fijos: (totalFijos / totalGastos) * 100,
                    variables: (totalVariables / totalGastos) * 100
                };
            }

            calcularRatioAhorro(transacciones) {
                const totalIngresos = transacciones
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalGastos = transacciones
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const ahorro = totalIngresos - totalGastos;
                
                if (totalIngresos === 0) return { ratio: 0, monto: 0 };
                
                return {
                    ratio: (ahorro / totalIngresos) * 100,
                    monto: ahorro
                };
            }

            calcularRatioEndeudamiento(transacciones) {
                const deudas = transacciones
                    .filter(t => t.category === 'Pr√©stamos' || t.category === 'Tarjetas')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const ingresos = transacciones
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                if (ingresos === 0) return 0;
                
                return (deudas / ingresos) * 100;
            }

            // An√°lisis de Tendencias
            calcularCrecimientoMensual(transacciones, tipo) {
                const mensual = this.agruparPorMes(transacciones.filter(t => t.type === tipo));
                const crecimiento = [];
                
                for (let i = 1; i < mensual.length; i++) {
                    const cambio = ((mensual[i].total - mensual[i-1].total) / mensual[i-1].total) * 100;
                    crecimiento.push({
                        mes: mensual[i].mes,
                        crecimiento: cambio,
                        tendencia: cambio > 0 ? 'positiva' : 'negativa'
                    });
                }
                
                return crecimiento;
            }

            calcularMediaMovil(transacciones, tipo, periodo = 3) {
                const mensual = this.agruparPorMes(transacciones.filter(t => t.type === tipo));
                const mediaMovil = [];
                
                for (let i = periodo - 1; i < mensual.length; i++) {
                    const suma = mensual.slice(i - periodo + 1, i + 1)
                        .reduce((sum, item) => sum + item.total, 0);
                    mediaMovil.push({
                        mes: mensual[i].mes,
                        mediaMovil: suma / periodo
                    });
                }
                
                return mediaMovil;
            }

            // An√°lisis Predictivo
            proyectarAhorros(transacciones, meses = 12) {
                const historialMensual = this.agruparPorMes(transacciones);
                const proyecciones = [];
                
                if (historialMensual.length < 2) {
                    // Si no hay suficientes datos, usar un crecimiento conservador del 5%
                    let ahorroActual = historialMensual.length > 0 ? 
                        this.calcularBalanceMensual(historialMensual[historialMensual.length - 1]) : 0;
                    
                    for (let i = 1; i <= meses; i++) {
                        ahorroActual *= 1.05; // 5% de crecimiento
                        proyecciones.push({
                            mes: i,
                            proyeccion: ahorroActual
                        });
                    }
                    return proyecciones;
                }
                
                // Calcular tasa de crecimiento promedio
                const crecimientoPromedio = this.calcularCrecimientoPromedio(historialMensual);
                
                let ahorroActual = this.calcularBalanceMensual(historialMensual[historialMensual.length - 1]);
                
                for (let i = 1; i <= meses; i++) {
                    ahorroActual *= (1 + crecimientoPromedio / 100);
                    proyecciones.push({
                        mes: i,
                        proyeccion: ahorroActual
                    });
                }
                
                return proyecciones;
            }

            detectarAnomalias(transacciones, tipo) {
                const montos = transacciones
                    .filter(t => t.type === tipo)
                    .map(t => t.amount);
                
                if (montos.length === 0) return [];
                
                const media = this.calcularMedia(transacciones, tipo);
                const desviacion = this.calcularDesviacionEstandar(transacciones, tipo);
                
                return transacciones.filter(t => 
                    t.type === tipo && 
                    Math.abs(t.amount - media) > 2 * desviacion
                );
            }

            // M√©todos auxiliares
            agruparPorMes(transacciones) {
                const agrupado = {};
                
                transacciones.forEach(t => {
                    const mes = t.date.substring(0, 7); // YYYY-MM
                    if (!agrupado[mes]) {
                        agrupado[mes] = {
                            mes: mes,
                            total: 0,
                            count: 0,
                            transacciones: []
                        };
                    }
                    
                    agrupado[mes].total += t.amount;
                    agrupado[mes].count++;
                    agrupado[mes].transacciones.push(t);
                });
                
                return Object.values(agrupado).sort((a, b) => a.mes.localeCompare(b.mes));
            }

            calcularBalanceMensual(datosMes) {
                const ingresos = datosMes.transacciones
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const gastos = datosMes.transacciones
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                return ingresos - gastos;
            }

            calcularCrecimientoPromedio(historialMensual) {
                let crecimientoTotal = 0;
                let conteo = 0;
                
                for (let i = 1; i < historialMensual.length; i++) {
                    const balanceActual = this.calcularBalanceMensual(historialMensual[i]);
                    const balanceAnterior = this.calcularBalanceMensual(historialMensual[i-1]);
                    
                    if (balanceAnterior !== 0) {
                        crecimientoTotal += ((balanceActual - balanceAnterior) / balanceAnterior) * 100;
                        conteo++;
                    }
                }
                
                return conteo > 0 ? crecimientoTotal / conteo : 5; // 5% por defecto si no hay datos
            }

            // Formatear fecha
            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES');
            }

            // Formatear mes
            formatMonth(monthString) {
                const [year, month] = monthString.split('-');
                const monthNames = [
                    'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
                    'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'
                ];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            }

            // Resetear formulario
            resetForm(formId) {
                document.getElementById(formId).reset();
                this.setDefaultDates();
            }

            // Mostrar toast
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type === 'error' ? 'error' : ''}`;
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // Cargar transacciones desde localStorage
            loadTransactions() {
                const stored = localStorage.getItem('smartBudgetTransactions');
                return stored ? JSON.parse(stored) : [];
            }

            // Guardar transacciones en localStorage
            saveTransactions() {
                localStorage.setItem('smartBudgetTransactions', JSON.stringify(this.transactions));
                localStorage.setItem('smartBudgetNextId', this.nextId.toString());
            }

            // Obtener siguiente ID
            getNextId() {
                const stored = localStorage.getItem('smartBudgetNextId');
                return stored ? parseInt(stored) : 1;
            }
        }

        // Sidebar Navigation
        class SidebarManager {
            constructor() {
                this.sidebar = document.getElementById('sidebar');
                this.toggleButton = document.getElementById('toggle-sidebar');
                this.menuItems = document.querySelectorAll('.menu-item');
                this.sections = document.querySelectorAll('section');
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setActiveSection('forms');
            }

            setupEventListeners() {
                // Toggle sidebar
                this.toggleButton.addEventListener('click', () => {
                    this.toggleSidebar();
                });

                // Menu item clicks
                this.menuItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.getAttribute('data-section');
                        this.setActiveSection(section);
                        this.scrollToSection(section);
                    });
                });

                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', (e) => {
                    if (window.innerWidth <= 768 && 
                        !this.sidebar.contains(e.target) && 
                        !e.target.classList.contains('toggle-sidebar')) {
                        this.sidebar.classList.add('collapsed');
                    }
                });
            }

            toggleSidebar() {
                this.sidebar.classList.toggle('collapsed');
            }

            setActiveSection(section) {
                // Remove active class from all menu items
                this.menuItems.forEach(item => {
                    item.classList.remove('active');
                });

                // Add active class to clicked menu item
                const activeItem = document.querySelector(`.menu-item[data-section="${section}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }

            scrollToSection(section) {
                const sectionElement = document.getElementById(`${section}-section`);
                if (sectionElement) {
                    sectionElement.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        }

        // Inicializar la aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            // Guardar instancia globalmente para que otras utilidades (ej. darkmode) puedan refrescar las gr√°ficas
            window.transactionManager = new TransactionManager();
            window.sidebarManager = new SidebarManager();
        });

        // Escuchar cambios de tema para refrescar gr√°ficas (cuando exista la instancia)
        document.addEventListener('theme-change', () => {
            if (window.transactionManager && typeof window.transactionManager.updateCharts === 'function') {
                window.transactionManager.updateCharts();
            }
        });
    </script>
    <script src="darkmode.js"></script>
    <script src="scriptlogin.js"></script>
</body>
</html>