DROP DATABASE IF EXISTS smartbudget;
CREATE DATABASE smartbudget;
USE smartbudget;

CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre_usuario VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    contrasena VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE transacciones (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    type ENUM('income','expense') NOT NULL,
    category VARCHAR(50) NOT NULL,
    description VARCHAR(255),
    amount DECIMAL(10,2) NOT NULL,
    date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES usuarios(id) ON DELETE CASCADE
);

DELIMITER $$

CREATE PROCEDURE ReordenarIDsUsuarios()
BEGIN
    CREATE TEMPORARY TABLE temp_users AS
    SELECT nombre_usuario, email, contrasena, created_at, updated_at
    FROM usuarios
    ORDER BY id;

    DELETE FROM usuarios;
    ALTER TABLE usuarios AUTO_INCREMENT = 1;

    INSERT INTO usuarios (nombre_usuario, email, contrasena, created_at, updated_at)
    SELECT nombre_usuario, email, contrasena, created_at, updated_at FROM temp_users;

    DROP TEMPORARY TABLE temp_users;
END$$

CREATE TRIGGER after_user_delete
AFTER DELETE ON usuarios
FOR EACH ROW
BEGIN
    CALL ReordenarIDsUsuarios();
END$$

DELIMITER ;

